rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- FUNÇÕES AUXILIARES ---
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function isResourceOwner() {
      return isAuthenticated() && resource.data.uidAutor == request.auth.uid;
    }

    // --- REGRAS DAS COLEÇÕES ---

    // 1. USUÁRIOS (USERS)
    match /users/{userId} {
      allow read: if true;
      allow create: if isOwner(userId);
      
      // Mantém regras existentes e adiciona permissão explícita
      // para que o próprio usuário atualize apenas 'stats.comments'
      allow update: if 
        (isOwner(userId) && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['xp', 'badges']))
        || 
        (isAuthenticated() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['seguidores']))
        ||
        // NOVA: permite que o dono atualize apenas stats.comments (increment/decrement via client)
        (isOwner(userId) && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['stats.comments']));
      
      allow delete: if false;
    }

    // 2. AVALIAÇÕES (REVIEWS)
    match /reviews/{reviewId} {
      allow read: if true;
      allow create: if isAuthenticated();
      
      // Permite owner atualizar qualquer coisa; permite autenticados alterarem
      // apenas campos de interação (curtidas/commentCount/reactions/lastCommentAt)
      allow update: if 
        isResourceOwner() 
        || 
        (isAuthenticated() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['curtidas', 'commentCount', 'reactions', 'lastCommentAt']));
      
      allow delete: if isResourceOwner();

      match /comments/{commentId} {
        allow read: if true;

        allow create: if isAuthenticated()
                       && request.resource.data.uidAutor == request.auth.uid
                       && request.resource.data.text is string
                       && ( !('authorInfo' in request.resource.data) || request.resource.data.authorInfo.nome is string );

        // Autor do comentário ou autor da review pode atualizar/excluir
        allow update, delete: if isResourceOwner() || 
                                get(/databases/$(database)/documents/reviews/$(reviewId)).data.uidAutor == request.auth.uid;
      }
    }

    // 3. LISTAS (LISTS)
    match /lists/{listId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update, delete: if isResourceOwner();
    }

    // 4. GRUPOS / CINECLUBES
    match /groups/{groupId} {
      allow read: if true;
      allow create: if isAuthenticated();
      
      allow update: if isAuthenticated() && (
        request.auth.uid == resource.data.adminId ||
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['members'])
      );
      
      allow delete: if isAuthenticated() && request.auth.uid == resource.data.adminId;

      match /posts/{postId} {
        allow read: if true;
        
        allow create: if isAuthenticated() && 
           request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.members;
        
        allow delete: if isAuthenticated() && (
           isResourceOwner() || 
           get(/databases/$(database)/documents/groups/$(groupId)).data.adminId == request.auth.uid
        );
        
        allow update: if isAuthenticated() && 
            request.resource.data.diff(resource.data).affectedKeys().hasAny(['likes', 'commentCount']);

        match /comments/{commentId} {
            allow read: if true;
            allow create: if isAuthenticated() && 
               request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.members;
            allow update, delete: if isResourceOwner();
        }
      }
    }

    // 5. CONVERSAS (CHAT PRIVADO)
    match /conversations/{conversationId} {
      allow create: if isAuthenticated() && request.auth.uid in request.resource.data.participants;
      allow read, update: if isAuthenticated() && request.auth.uid in resource.data.participants;
      
      match /messages/{messageId} {
        allow read: if isAuthenticated() && request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;
        
        allow create: if isAuthenticated() && request.resource.data.senderId == request.auth.uid;
        
        // Atualizações:
        // - remetente pode atualizar sua própria mensagem (exceto movie_invite handling)
        // - participantes podem marcar aceitação em movie_invite, desde que:
        //   * apenas 'acceptedBy' seja alterado
        //   * acceptedBy aumente adequadamente e contenha o autor da requisição
        allow update: if 
          (isAuthenticated() && resource.data.senderId == request.auth.uid && resource.data.type != 'movie_invite' && resource.data.type != 'movieInvite')
          ||
          (
            isAuthenticated() &&
            // verifica se quem tenta atualizar é participante da conversa
            request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants &&
            // aceitamentos de convite: suportar 'movie_invite', 'movieInvite' ou ausência de type
            (resource.data.type == 'movie_invite' || resource.data.type == 'movieInvite' || !('type' in resource.data)) &&
            // permite apenas alteração do campo acceptedBy
            request.resource.data.diff(resource.data).affectedKeys().hasOnly(['acceptedBy']) &&
            // garante que o auth.uid está presente no novo acceptedBy
            request.auth.uid in request.resource.data.acceptedBy &&
            // valida incremento correto, cobrindo ambos os casos:
            // - acceptedBy não existia antes -> novo tamanho deve ser 1
            // - acceptedBy existia -> novo tamanho == old + 1
            (
              ( !('acceptedBy' in resource.data) && request.resource.data.acceptedBy.size() == 1 )
              ||
              ( 'acceptedBy' in resource.data && request.resource.data.acceptedBy.size() == resource.data.acceptedBy.size() + 1 )
            )
          );

        allow delete: if isAuthenticated() && resource.data.senderId == request.auth.uid;
      }
    }

    // 6. NOTIFICAÇÕES
    match /notifications/{notifId} {
      allow read, update, delete: if isAuthenticated() && resource.data.recipientId == request.auth.uid;
      // Permite que o cliente crie notificações quando senderId == auth.uid (notificações iniciadas pelo usuário)
      allow create: if isAuthenticated() && request.resource.data.senderId == request.auth.uid;
    }

    // 7. CINEMATCH
    match /cinematch/{sessionId} {
      allow read, write: if isAuthenticated();
    }

    // 8. CONQUISTAS (ACHIEVEMENTS)
    match /achievements/{achievementId} {
      allow read: if true;
      allow write: if false; // Apenas o servidor (Admin SDK) pode dar conquistas
    }
  }
}
